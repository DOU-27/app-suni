{% extends "base/base.html" %}

{% load staticfiles %}

{% block page_title %}
<title>Garantía - {{ garantia.id }}</title>
{% endblock page_title %}

{% block content %}
<section class="content-header">
	<h1>Garantia No. {{ garantia.id }}</h1>
</section>
<section class="content">
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-3">
				<div class="box">
					<div class="box-header with-border">
						<h3 class="box-title">Información</h3>
					</div>
					<div class="box-body">
						<table class="table table-striped">
							<tr>
								<th>Escuela</th>
								<td>
									<a href="{{ garantia.equipamiento.escuela.get_absolute_url }}">{{ garantia.equipamiento.escuela }}</a>
								</td>
							</tr>
							<tr>
								<th>Entrega</th>
								<td>{{ garantia.equipamiento }}</td>
							</tr>
							<tr>
								<th>Fecha de entrega</th>
								<td>{{ garantia.equipamiento.fecha }}</td>
							</tr>
							<tr>
								<th>Fecha de vencimiento</th>
								<td>{{ garantia.fecha_vencimiento }}</td>
							</tr>
							<tr>
								<th>Estado</th>
								<td>
									{% if garantia.get_vigente %}
										Vigente
									{% else %}
										Vencida
									{% endif %}
								</td>
							</tr>
						</table>
					</div>
				</div>
			</div>

			<div class="col-md-9">
				<div class="box box-primary">
					<div class="box-header with-border">
						<h3 class="box-title">Tickets de soporte</h3>
						{% if perms.tpe.add_ticketsoporte %}
							<div class="box-tools pull-right">
								<button class="btn btn-primary" id="button-nuevo-ticket"><i class="fa fa-plus"></i> Nuevo</button>
							</div>
						{% endif %}
					</div>
					<div class="box-body">
						{% if perms.tpe.add_ticketsoporte %}
							<form method="post" action="{% url 'ticket_soporte_add' %}" id="form-nuevo-ticket">
								{% csrf_token %}
								{{ ticket_form.as_p }}
								<input type="submit" value="Crear" class="btn btn-success"></input>
								<br /><br>
							</form>
						{% endif %}
						{% for ticket in garantia.tickets.all %}
							<div class="box box-primary box-solid {% if ticket_detail.id != ticket.id %} collapsed-box {% endif %}">
								<div class="box-header with-border">
									<h3 class="box-title">Ticket {{ ticket.id }}</h3> {% if ticket.cerrado != True %} (Pendiente){% endif %}
									<div class="box-tools pull-right">
										<button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
									</div>
								</div>
								<div class="box-body">
									<div class="row">
										<div class="col-md-4">
											<table class="table table-striped table-hover">
												<tr>
													<th>Abierto por</th>
													<td>{{ ticket.abierto_por.perfil }} {{ ticket.costos }}</td>
												</tr>
												<tr>
													<th>Fecha de creación</th>
													<td>{{ ticket.fecha_abierto }}</td>
												</tr>
												<tr>
													<th>Descripción</th>
													<td>
														{% if ticket.descripcion %}
															{{ ticket.descripcion }}
														{% endif %}
													</td>
												</tr>
												<tr>
													<th>Fecha de cierre</th>
													<td>
														{% if ticket.fecha_cierre %}
															{{ ticket.fecha_cierre }}
														{% endif %}
													</td>
												</tr>
												<tr>
													<th>Estado</th>
													<td>
														{% if ticket.cerrado %}
															Cerrado
														{% else %}
															Sin solucionar
														{% endif %}
													</td>
												</tr>
												<tr>
													<td colspan="2">
														{% if ticket.cerrado != True %}
															<form action="{% url 'ticket_soporte_update' pk=ticket.id %}" method="post">
																{% csrf_token %}
																{{ ticket_cerrado_form.as_table }}
																<input type="submit" class="btn btn-danger btn-flat" value="Cerrar">
															</form>
														{% endif %}
													</td>
												</tr>
											</table>
										</div>
										<div class="col-md-8">
											<h4>
												Historial
												{% if ticket.cerrado != True %}
													<button onclick="$('#registro-{{ ticket.id }}').toggle();" class="btn btn-info btn-flat"><i class="fa fa-plus"></i></button>
												{% endif %}
											</h4>
											<div class="box box-solid box-warning form-nuevo-registro" id="registro-{{ ticket.id }}">
												<form action="{% url 'ticket_registro_add' ticket_id=ticket.id %}" class="box-body" method="post">
													{% csrf_token %}
													<table class="table">
														{{ ticket_registro_form.as_table }}
														<tr>
															<td></td>
															<td><input type="submit" value="Crear" class="btn btn-success"></td>
														</tr>
													</table>
												</form>
											</div>
											<div class="direct-chat-messages">
											{% for registro in ticket.registros.all %}
												<div class="direct-chat-msg">
													<div class="direct-chat-info clearfix">
														<span class="direct-chat-name pull-left">{{ registro.usuario.perfil }}</span>
														<span class="direct-chat-timestamp pull-right">{{ registro.fecha }}</span>
													</div>
													<div class="direct-chat-text">
														{{ registro.descripcion }}
														<ul>
															<li><b>{{ registro.tipo }}</b></li>
															<li><b>Costo de envío:</b> Q {{ registro.costo_envio }}</li>
															<li><b>Costo de reparación:</b> Q {{ registro.costo_reparacion }}</li>
														</ul>
													</div>
												</div>
											{% endfor %}
											</div>
										</div>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
{% endblock content %}

{% block extra_js %}
<script src="{% static "js/extrajs/tpe.js" %}"></script>
<script>
	DetalleGarantia.init();
</script>
{% endblock extra_js %}